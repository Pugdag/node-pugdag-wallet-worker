"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Storage = void 0;
const logger_1 = require("../utils/logger");
const helper_1 = require("../utils/helper");
const IS_NODE = typeof process === 'object'
    && typeof process.versions === 'object'
    && typeof process.versions.node === 'string';
class DBInterface {
}
const classes = {};
class LSDB extends DBInterface {
    constructor(opt = {}) {
        super();
        this.LS = window.localStorage;
    }
    backup() {
        let data = this.getWallet();
        if (!data)
            return;
        let ts = Date.now();
        this.LS.setItem("pugdag-wallet-" + ts, data);
        let cache = this.getCache();
        if (cache)
            this.LS.setItem("pugdag-cache-" + ts, cache);
    }
    saveWallet(data) {
        this.LS.setItem("pugdag-wallet", data);
    }
    getWallet() {
        return this.LS.getItem("pugdag-wallet");
    }
    saveCache(cache) {
        return this.LS.setItem("pugdag-cache", cache);
    }
    getCache() {
        return this.LS.getItem("pugdag-cache");
    }
}
classes.LSDB = LSDB;
if (IS_NODE) {
    const path = require("path");
    const os = require("os");
    const fs = require("fs");
    class FileDB extends DBInterface {
        constructor(opt = {}) {
            super();
            let { fileName = "pugdag", folder } = opt;
            this.fileName = fileName;
            this.folder = folder || this.getHomeFolder();
            if (!fs.existsSync(this.folder))
                fs.mkdirSync(this.folder, { recursive: true });
            this.walletFile = this.createFilePath('kpk');
            this.txFile = this.createFilePath('ktx');
            this.cacheFile = this.createFilePath('cache');
        }
        createFilePath(ext = 'kpk', suffix = '') {
            return path.join(this.folder, `${this.fileName}${suffix}.${ext}`);
        }
        getHomeFolder() {
            let { APPDATA, HOME } = process.env;
            if (!HOME)
                HOME = os.homedir();
            if (APPDATA) // windows
                return path.join(APPDATA, 'Pugdag');
            if (process.platform == 'darwin')
                return path.join(HOME, '/Library/Application Support/Pugdag/');
            return path.join(HOME, '.pugdag');
        }
        backup() {
            let bk = '-backup-' + (0, helper_1.UID)("-");
            if (fs.existsSync(this.walletFile)) {
                let newPath = this.createFilePath('kpk', bk);
                fs.renameSync(this.walletFile, newPath);
            }
            if (fs.existsSync(this.txFile)) {
                let newPath = this.createFilePath('ktx', bk);
                fs.renameSync(this.txFile, newPath);
            }
            if (fs.existsSync(this.cacheFile)) {
                let newPath = this.createFilePath('cache', bk);
                fs.renameSync(this.cacheFile, newPath);
            }
        }
        saveWallet(data) {
            fs.writeFileSync(this.walletFile, data);
        }
        getWallet() {
            if (fs.existsSync(this.walletFile))
                return fs.readFileSync(this.walletFile) + "";
            return false;
        }
        saveCache(cache) {
            return fs.writeFileSync(this.cacheFile, cache);
        }
        getCache() {
            if (fs.existsSync(this.cacheFile))
                return fs.readFileSync(this.cacheFile) + "";
            return undefined;
        }
    }
    classes.FileDB = FileDB;
}
class Storage {
    constructor(opt = {}) {
        this.logger = (0, logger_1.CreateLogger)("PugdagStorage");
        const { fileDbOptions = {} } = opt;
        if (opt.logLevel)
            this.setLogLevel(opt.logLevel);
        if (IS_NODE) {
            this.db = new classes.FileDB(fileDbOptions);
        }
        else {
            this.db = new classes.LSDB();
        }
    }
    /*
    * @return {String|Buffer} wallet
    */
    getWallet() {
        let content = this.db.getWallet();
        if (!content)
            return false;
        try {
            return JSON.parse(content);
        }
        catch (e) {
            return false;
        }
    }
    _buildWalletContent(mnemonic, meta = {}) {
        return Object.assign({
            type: "pugdag-wallet",
            encryption: "default",
            version: 1,
            generator: "cli",
            wallet: {
                mnemonic
            }
        }, meta || {});
    }
    createWallet(mnemonic, meta = {}) {
        //this.logger.debug("createWallet:", wallet)
        this.db.backup();
        this.db.saveCache('');
        return this.saveWallet(mnemonic, meta);
    }
    saveWallet(mnemonic, meta = {}) {
        //this.logger.debug("saveWallet:", wallet)
        let wallet = this._buildWalletContent(mnemonic, meta);
        let json = JSON.stringify(wallet);
        return this.db.saveWallet(json);
    }
    /*
    * @return {WalletCache|undefined} cache
    */
    getCache() {
        let cache = this.db.getCache();
        if (!cache)
            return false;
        try {
            return JSON.parse(cache);
        }
        catch (e) {
            return false;
        }
    }
    saveCache(cache) {
        let data = JSON.stringify(cache);
        this.db.saveCache(data);
    }
    setLogLevel(level) {
        this.logger.setLevel(level);
    }
    addTransaction(tx) {
    }
}
exports.Storage = Storage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3dhbGxldC9zdG9yYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRDQUFxRDtBQUNyRCw0Q0FBb0M7QUFJcEMsTUFBTSxPQUFPLEdBQUcsT0FBTyxPQUFPLEtBQUssUUFBUTtPQUN2QyxPQUFPLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUTtPQUNwQyxPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQztBQXNDOUMsTUFBZSxXQUFXO0NBTXpCO0FBT0QsTUFBTSxPQUFPLEdBQWdDLEVBQUUsQ0FBQztBQUVoRCxNQUFNLElBQUssU0FBUSxXQUFXO0lBRTdCLFlBQVksTUFBYyxFQUFFO1FBQzNCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO0lBQy9CLENBQUM7SUFFRCxNQUFNO1FBQ0wsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzVCLElBQUcsQ0FBQyxJQUFJO1lBQ1AsT0FBTTtRQUNQLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsR0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzVCLElBQUcsS0FBSztZQUNQLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLGdCQUFnQixHQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBQ0QsVUFBVSxDQUFDLElBQVc7UUFDckIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELFNBQVM7UUFD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QUFDO0lBQ3pCLENBQUM7SUFFRCxXQUFXLENBQUMsS0FBWTtRQUN2QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUM1QixDQUFDO0lBRUQsY0FBYyxDQUFDLEVBQWM7SUFFN0IsQ0FBQztDQUNEO0FBcEZELDBCQW9GQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q3JlYXRlTG9nZ2VyLCBMb2dnZXJ9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQge1VJRH0gZnJvbSAnLi4vdXRpbHMvaGVscGVyJztcbmltcG9ydCB7IFdhbGxldENhY2hlIH0gZnJvbSAnLi4vdHlwZXMvY3VzdG9tLXR5cGVzJztcblxuZXhwb3J0IHR5cGUgU3RvcmFnZVR5cGUgPSAnRklMRSd8J0xTJztcbmNvbnN0IElTX05PREUgPSB0eXBlb2YgcHJvY2VzcyA9PT0gJ29iamVjdCcgXG5cdCYmIHR5cGVvZiBwcm9jZXNzLnZlcnNpb25zID09PSAnb2JqZWN0J1xuXHQmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucy5ub2RlID09PSAnc3RyaW5nJztcblxuZXhwb3J0IHR5cGUgU3RvcmFnZU9wdHMgPSB7XG5cdGxvZ0xldmVsPzpzdHJpbmcsXG5cdHBhc3N3b3JkPzpzdHJpbmcsXG5cdGZpbGVEYk9wdGlvbnM/Ontcblx0XHRmaWxlTmFtZT86c3RyaW5nLFxuXHRcdGZvbGRlcj86c3RyaW5nXG5cdH1cbn07XG5leHBvcnQgaW50ZXJmYWNlIFRYU3RvcmVJdGVte1xuXHRpbjpib29sZWFuO1xuXHR0czpudW1iZXI7XG5cdGlkOnN0cmluZztcblx0YW1vdW50Om51bWJlcjtcblx0YWRkcmVzczpzdHJpbmc7XG5cdG5vdGU/OnN0cmluZztcblx0dHg/OmFueVxufVxuZXhwb3J0IGludGVyZmFjZSBXYWxsZXRNZXRhe1xuXHR2ZXJzaW9uPzpzdHJpbmc7XG5cdGdlbmVyYXRvcj86c3RyaW5nO1xuXHRlbmNyeXB0aW9uPzpzdHJpbmc7XG5cdHdhbGxldD86e21uZW1vbmljPzpzdHJpbmd9XG59XG5leHBvcnQgaW50ZXJmYWNlIFdhbGxldENvbnRlbnR7XG5cdHR5cGU6c3RyaW5nO1xuXHR2ZXJzaW9uOnN0cmluZztcblx0Z2VuZXJhdG9yOnN0cmluZztcblx0ZW5jcnlwdGlvbjpzdHJpbmc7XG5cdHdhbGxldDp7bW5lbW9uaWM6c3RyaW5nfVxufVxuXG5pbnRlcmZhY2UgREJPcHRpb25ze1xuXHRmaWxlTmFtZT86c3RyaW5nLFxuXHRmb2xkZXI/OnN0cmluZ1xufVxuXG5hYnN0cmFjdCBjbGFzcyBEQkludGVyZmFjZXtcblx0YWJzdHJhY3QgYmFja3VwKCk6dm9pZDtcblx0YWJzdHJhY3Qgc2F2ZVdhbGxldChkYXRhOnN0cmluZyk6dm9pZDtcblx0YWJzdHJhY3QgZ2V0V2FsbGV0KCk6c3RyaW5nfGZhbHNlO1xuXHRhYnN0cmFjdCBnZXRDYWNoZSgpOnN0cmluZ3x1bmRlZmluZWQ7XG5cdGFic3RyYWN0IHNhdmVDYWNoZShjYWNoZTpzdHJpbmcpOnZvaWRcbn1cblxuaW50ZXJmYWNlIERCQ29uc3RydWN0b3Ige1xuICAgIG5ldyAob3B0PzpEQk9wdGlvbnMpOiBEQkludGVyZmFjZTtcbn1cblxuXG5jb25zdCBjbGFzc2VzOntba2V5OnN0cmluZ106REJDb25zdHJ1Y3Rvcn0gPSB7fTtcblxuY2xhc3MgTFNEQiBleHRlbmRzIERCSW50ZXJmYWNle1xuXHRMUzogYW55O1xuXHRjb25zdHJ1Y3RvcihvcHQ6REJPcHRpb25zPXt9KXtcblx0XHRzdXBlcigpO1xuXHRcdHRoaXMuTFMgPSB3aW5kb3cubG9jYWxTdG9yYWdlO1xuXHR9XG5cblx0YmFja3VwKCk6dm9pZHtcblx0XHRsZXQgZGF0YSA9IHRoaXMuZ2V0V2FsbGV0KCk7XG5cdFx0aWYoIWRhdGEpXG5cdFx0XHRyZXR1cm5cblx0XHRsZXQgdHMgPSBEYXRlLm5vdygpO1xuXHRcdHRoaXMuTFMuc2V0SXRlbShcImthcmxzZW4td2FsbGV0LVwiK3RzLCBkYXRhKTtcblx0XHRsZXQgY2FjaGUgPSB0aGlzLmdldENhY2hlKCk7XG5cdFx0aWYoY2FjaGUpXG5cdFx0XHR0aGlzLkxTLnNldEl0ZW0oXCJrYXJsc2VuLWNhY2hlLVwiK3RzLCBjYWNoZSk7XG5cdH1cblx0c2F2ZVdhbGxldChkYXRhOnN0cmluZyk6dm9pZHtcblx0XHR0aGlzLkxTLnNldEl0ZW0oXCJrYXJsc2VuLXdhbGxldFwiLCBkYXRhKTtcblx0fVxuXG5cdGdldFdhbGxldCgpOnN0cmluZ3xmYWxzZXtcblx0XHRyZXR1cm4gdGhpcy5MUy5nZXRJdGVtKFwia2FybHNlbi13YWxsZXRcIik7XG5cdH1cblxuXHRzYXZlQ2FjaGUoY2FjaGU6c3RyaW5nKXtcblx0XHRyZXR1cm4gdGhpcy5MUy5zZXRJdGVtKFwia2FybHNlbi1jYWNoZVwiLCBjYWNoZSk7XG5cdH1cblxuXHRnZXRDYWNoZSgpOnN0cmluZ3x1bmRlZmluZWR7XG5cdFx0cmV0dXJuIHRoaXMuTFMuZ2V0SXRlbShcImthcmxzZW4tY2FjaGVcIik7XG5cdH1cbn1cblxuY2xhc3Nlcy5MU0RCID0gTFNEQjtcblxuaWYoSVNfTk9ERSl7XG5cdGNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcblx0Y29uc3Qgb3MgPSByZXF1aXJlKFwib3NcIik7XG5cdGNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuXG5cdGNsYXNzIEZpbGVEQiBleHRlbmRzIERCSW50ZXJmYWNle1xuXHRcdHdhbGxldEZpbGU6c3RyaW5nO1xuXHRcdHR4RmlsZTpzdHJpbmc7XG5cdFx0ZmlsZU5hbWU6c3RyaW5nO1xuXHRcdGZvbGRlcjpzdHJpbmc7XG5cdFx0Y2FjaGVGaWxlOnN0cmluZztcblxuXHRcdGNvbnN0cnVjdG9yKG9wdDpEQk9wdGlvbnM9e30pe1xuXHRcdFx0c3VwZXIoKTtcblx0XHRcdGxldCB7ZmlsZU5hbWU9XCJrYXJsc2VuXCIsIGZvbGRlcn0gPSBvcHQ7XG5cdFx0XHR0aGlzLmZpbGVOYW1lID0gZmlsZU5hbWU7XG5cdFx0XHR0aGlzLmZvbGRlciA9IGZvbGRlcnx8dGhpcy5nZXRIb21lRm9sZGVyKCk7XG5cdFx0XHRpZighZnMuZXhpc3RzU3luYyh0aGlzLmZvbGRlcikpXG5cdFx0XHRcdGZzLm1rZGlyU3luYyh0aGlzLmZvbGRlciwge3JlY3Vyc2l2ZTp0cnVlfSlcblx0XHRcdHRoaXMud2FsbGV0RmlsZSA9IHRoaXMuY3JlYXRlRmlsZVBhdGgoJ2twaycpO1xuXHRcdFx0dGhpcy50eEZpbGUgPSB0aGlzLmNyZWF0ZUZpbGVQYXRoKCdrdHgnKTtcblx0XHRcdHRoaXMuY2FjaGVGaWxlID0gdGhpcy5jcmVhdGVGaWxlUGF0aCgnY2FjaGUnKTtcblx0XHR9XG5cblx0XHRjcmVhdGVGaWxlUGF0aChleHQ9J2twaycsIHN1ZmZpeD0nJyl7XG5cdFx0XHRyZXR1cm4gcGF0aC5qb2luKHRoaXMuZm9sZGVyLCBgJHt0aGlzLmZpbGVOYW1lfSR7c3VmZml4fS4ke2V4dH1gKTtcblx0XHR9XG5cblx0XHRnZXRIb21lRm9sZGVyKCl7XG5cdFx0XHRsZXQge0FQUERBVEEsIEhPTUV9ID0gcHJvY2Vzcy5lbnY7XG5cdFx0XHRpZighSE9NRSlcblx0XHRcdFx0SE9NRSA9IG9zLmhvbWVkaXIoKTtcblxuXHRcdFx0aWYoQVBQREFUQSkgLy8gd2luZG93c1xuXHRcdFx0XHRyZXR1cm4gcGF0aC5qb2luKEFQUERBVEEsICdLYXJsc2VuJyk7XG5cblx0XHRcdGlmKHByb2Nlc3MucGxhdGZvcm0gPT0gJ2RhcndpbicpXG5cdFx0XHRcdHJldHVybiBwYXRoLmpvaW4oSE9NRSwnL0xpYnJhcnkvQXBwbGljYXRpb24gU3VwcG9ydC9LYXJsc2VuLycpO1xuXG5cdFx0XHRyZXR1cm4gcGF0aC5qb2luKEhPTUUsICcua2FybHNlbicpO1xuXHRcdH1cblxuXHRcdGJhY2t1cCgpe1xuXHRcdFx0bGV0IGJrID0gJy1iYWNrdXAtJytVSUQoXCItXCIpO1xuXG5cdFx0XHRpZihmcy5leGlzdHNTeW5jKHRoaXMud2FsbGV0RmlsZSkpe1xuXHRcdFx0XHRsZXQgbmV3UGF0aCA9IHRoaXMuY3JlYXRlRmlsZVBhdGgoJ2twaycsIGJrKVxuXHRcdFx0XHRmcy5yZW5hbWVTeW5jKHRoaXMud2FsbGV0RmlsZSwgbmV3UGF0aCk7XG5cdFx0XHR9XG5cdFx0XHRpZihmcy5leGlzdHNTeW5jKHRoaXMudHhGaWxlKSl7XG5cdFx0XHRcdGxldCBuZXdQYXRoID0gdGhpcy5jcmVhdGVGaWxlUGF0aCgna3R4JywgYmspXG5cdFx0XHRcdGZzLnJlbmFtZVN5bmModGhpcy50eEZpbGUsIG5ld1BhdGgpO1xuXHRcdFx0fVxuXHRcdFx0aWYoZnMuZXhpc3RzU3luYyh0aGlzLmNhY2hlRmlsZSkpe1xuXHRcdFx0XHRsZXQgbmV3UGF0aCA9IHRoaXMuY3JlYXRlRmlsZVBhdGgoJ2NhY2hlJywgYmspXG5cdFx0XHRcdGZzLnJlbmFtZVN5bmModGhpcy5jYWNoZUZpbGUsIG5ld1BhdGgpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHNhdmVXYWxsZXQoZGF0YTpzdHJpbmcpOnZvaWR7XG5cdFx0XHRmcy53cml0ZUZpbGVTeW5jKHRoaXMud2FsbGV0RmlsZSwgZGF0YSk7XG5cdFx0fVxuXG5cdFx0Z2V0V2FsbGV0KCk6c3RyaW5nfGZhbHNle1xuXHRcdFx0aWYoZnMuZXhpc3RzU3luYyh0aGlzLndhbGxldEZpbGUpKVxuXHRcdFx0XHRyZXR1cm4gZnMucmVhZEZpbGVTeW5jKHRoaXMud2FsbGV0RmlsZSkrXCJcIjtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cblx0XHRzYXZlQ2FjaGUoY2FjaGU6c3RyaW5nKXtcblx0XHRcdHJldHVybiBmcy53cml0ZUZpbGVTeW5jKHRoaXMuY2FjaGVGaWxlLCBjYWNoZSk7XG5cdFx0fVxuXHRcblx0XHRnZXRDYWNoZSgpOnN0cmluZ3x1bmRlZmluZWR7XG5cdFx0XHRpZihmcy5leGlzdHNTeW5jKHRoaXMuY2FjaGVGaWxlKSlcblx0XHRcdFx0cmV0dXJuIGZzLnJlYWRGaWxlU3luYyh0aGlzLmNhY2hlRmlsZSkrXCJcIjtcblx0XHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdFx0fVxuXHR9XG5cblx0Y2xhc3Nlcy5GaWxlREIgPSBGaWxlREI7XG59XG5cbmV4cG9ydCBjbGFzcyBTdG9yYWdle1xuXG5cdGxvZ2dlcjphbnk7XG5cdGRiOkRCSW50ZXJmYWNlO1xuXHRjb25zdHJ1Y3RvcihvcHQ6U3RvcmFnZU9wdHM9e30pe1xuXHRcdHRoaXMubG9nZ2VyID0gQ3JlYXRlTG9nZ2VyKFwiS2FybHNlblN0b3JhZ2VcIik7XG5cdFx0Y29uc3Qge2ZpbGVEYk9wdGlvbnM9e319ID0gb3B0O1xuXG5cdFx0aWYob3B0LmxvZ0xldmVsKVxuXHRcdFx0dGhpcy5zZXRMb2dMZXZlbChvcHQubG9nTGV2ZWwpXG5cblx0XHRpZihJU19OT0RFKXtcblx0XHRcdHRoaXMuZGIgPSBuZXcgY2xhc3Nlcy5GaWxlREIoZmlsZURiT3B0aW9ucyk7XG5cdFx0fWVsc2V7XG5cdFx0XHR0aGlzLmRiID0gbmV3IGNsYXNzZXMuTFNEQigpO1xuXHRcdH1cblx0fVxuXG5cdC8qXG5cdCogQHJldHVybiB7U3RyaW5nfEJ1ZmZlcn0gd2FsbGV0XG5cdCovXG5cdGdldFdhbGxldCgpOldhbGxldENvbnRlbnR8ZmFsc2V7XG5cdFx0bGV0IGNvbnRlbnQgPSB0aGlzLmRiLmdldFdhbGxldCgpO1xuXHRcdGlmKCFjb250ZW50KVxuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdHRyeXtcblx0XHRcdHJldHVybiBKU09OLnBhcnNlKGNvbnRlbnQpO1xuXHRcdH1jYXRjaChlKXtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdH1cblxuXHRfYnVpbGRXYWxsZXRDb250ZW50KG1uZW1vbmljOnN0cmluZywgbWV0YTpXYWxsZXRNZXRhPXt9KXtcblx0XHRyZXR1cm4gT2JqZWN0LmFzc2lnbih7XG5cdFx0XHR0eXBlOiBcImthcmxzZW4td2FsbGV0XCIsXG5cdFx0XHRlbmNyeXB0aW9uOiBcImRlZmF1bHRcIixcblx0XHRcdHZlcnNpb246IDEsXG5cdFx0XHRnZW5lcmF0b3I6IFwiY2xpXCIsXG5cdFx0XHR3YWxsZXQ6IHtcblx0XHRcdFx0bW5lbW9uaWNcblx0XHRcdH1cblx0XHR9LCBtZXRhfHx7fSlcblx0fVxuXG5cdGNyZWF0ZVdhbGxldChtbmVtb25pYzpzdHJpbmcsIG1ldGE6V2FsbGV0TWV0YT17fSl7XG5cdFx0Ly90aGlzLmxvZ2dlci5kZWJ1ZyhcImNyZWF0ZVdhbGxldDpcIiwgd2FsbGV0KVxuXHRcdHRoaXMuZGIuYmFja3VwKCk7XG5cdFx0dGhpcy5kYi5zYXZlQ2FjaGUoJycpXG5cdFx0cmV0dXJuIHRoaXMuc2F2ZVdhbGxldChtbmVtb25pYywgbWV0YSk7XG5cdH1cblx0c2F2ZVdhbGxldChtbmVtb25pYzpzdHJpbmcsIG1ldGE6V2FsbGV0TWV0YT17fSl7XG5cdFx0Ly90aGlzLmxvZ2dlci5kZWJ1ZyhcInNhdmVXYWxsZXQ6XCIsIHdhbGxldClcblx0XHRsZXQgd2FsbGV0ID0gdGhpcy5fYnVpbGRXYWxsZXRDb250ZW50KG1uZW1vbmljLCBtZXRhKTtcblx0XHRsZXQganNvbiA9IEpTT04uc3RyaW5naWZ5KHdhbGxldClcblx0XHRyZXR1cm4gdGhpcy5kYi5zYXZlV2FsbGV0KGpzb24pO1xuXHR9XG5cblx0Lypcblx0KiBAcmV0dXJuIHtXYWxsZXRDYWNoZXx1bmRlZmluZWR9IGNhY2hlXG5cdCovXG5cdGdldENhY2hlKCk6V2FsbGV0Q2FjaGV8ZmFsc2V7XG5cdFx0bGV0IGNhY2hlID0gdGhpcy5kYi5nZXRDYWNoZSgpO1xuXHRcdGlmKCFjYWNoZSlcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcblx0XHR0cnl7XG5cdFx0XHRyZXR1cm4gSlNPTi5wYXJzZShjYWNoZSk7XG5cdFx0fWNhdGNoKGUpe1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0fVxuXG5cdHNhdmVDYWNoZShjYWNoZTpXYWxsZXRDYWNoZSl7XG5cdFx0bGV0IGRhdGEgPSBKU09OLnN0cmluZ2lmeShjYWNoZSk7XG5cdFx0dGhpcy5kYi5zYXZlQ2FjaGUoZGF0YSk7XG5cdH1cblxuXHRzZXRMb2dMZXZlbChsZXZlbDpzdHJpbmcpe1xuXHRcdHRoaXMubG9nZ2VyLnNldExldmVsKGxldmVsKVxuXHR9XG5cblx0YWRkVHJhbnNhY3Rpb24odHg6VFhTdG9yZUl0ZW0pe1xuXG5cdH1cbn1cblxuXG4iXX0=