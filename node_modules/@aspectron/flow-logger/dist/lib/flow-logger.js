"use strict";
/*

Usage example:

const log = new FlowLogger('TestLogger', { display : ['name','level'], custom : ['levelA:cyan','levelB'], color: 'name level' });
log.levels.enable('levelA levelB');
log.info('info log');
log.info.trace('info trace');  // prints stack trace
log.levels.disable('all').enable('debug trace');
log.trace('trace test);
log.debug('debug test);

*/
Object.defineProperty(exports, "__esModule", { value: true });
exports.FlowLogger = void 0;
let Colors;
// @ts-ignore
let isNODE = typeof window == 'undefined'
    // @ts-ignore
    && typeof process === "object"
    // @ts-ignore
    && `${process}` === "[object process]"
    // @ts-ignore
    && typeof require == 'function';
// @ts-ignore
if (isNODE && typeof nw !== 'undefined')
    isNODE = false;
if (isNODE) {
    // @ts-ignore
    Colors = require('@aspectron/colors.ts');
}
function ansi_color(text, color) {
    return Colors.colors(color, text);
}
function theme(theme) {
    if (isNODE && Colors) {
        Colors.theme(theme);
    }
}
let prefix_ids = 0;
const prefixes = {
    'time': 1 << prefix_ids++,
    'name': 1 << prefix_ids++,
    'level': 1 << prefix_ids++
};
const { time: time_prefix, name: name_prefix, level: level_prefix } = prefixes;
const levels = {
    error: 'red',
    warn: 'magenta',
    info: 'white',
    verbose: 'yellow',
    network: 'blue',
    profile: 'cyan',
    trace: 'grey',
    debug: 'green',
};
class FlowLogger {
    constructor(name, options = {}) {
        if (typeof name != 'string')
            throw new Error('FlowLogger::constructor() - first argument must be a string');
        let opt = Object.assign({
            sink: null,
            levels: ['error', 'warn', 'info'],
            display: ['level'],
            custom: {},
            color: ['name', 'level'] // component to color time|name|level|content
        }, options);
        this.name = name;
        this.name_prefix_ = `[${name}]`;
        this.level_bits = 0;
        this.to_id = {};
        this.to_color = {};
        this.levels_ui32_ = 0;
        this.prefix_color_ui32 = 0;
        this.profiles = {};
        let custom = {};
        if (Array.isArray(opt.custom))
            opt.custom.forEach(l => {
                let [level, color] = l.split(':');
                custom[level] = color || 'white';
            });
        else
            custom = opt.custom;
        this.sink = opt.sink;
        this.create(Object.assign(Object.assign({}, levels), custom)).enable(opt.levels).enable(Object.keys(custom));
        if (opt.color)
            theme(this.to_color);
        this.prefix_ui32 = opt.display.reduce((v, l) => v | prefixes[l], 0);
        this.prefix_color_ui32 = 0;
        Object.entries(prefixes).forEach(([prefix, bit]) => {
            if (opt.color.includes(prefix) || opt.color.includes('prefix') || opt.color.includes('all'))
                this.prefix_color_ui32 |= bit;
        });
        this.color_content = opt.color.includes('content') || opt.color.includes('all');
    }
    //[fn:string] : logfn;
    static getTS() {
        let d = (new Date());
        let year = d.getFullYear();
        let month = d.getMonth() + 1;
        month = month < 10 ? '0' + month : month;
        let date = d.getDate();
        date = date < 10 ? '0' + date : date;
        let hour = d.getHours();
        hour = hour < 10 ? '0' + hour : hour;
        let min = d.getMinutes();
        min = min < 10 ? '0' + min : min;
        let sec = d.getSeconds();
        sec = sec < 10 ? '0' + sec : sec;
        //var time = year + '-' + month + '-' + date + ' ' + hour + ':' + min + ':' + sec;
        return `${year}-${month}-${date} ${hour}:${min}:${sec}`;
    }
    create(descriptor) {
        Object.entries(descriptor).forEach(([level, color]) => {
            if (this.level_bits > 32)
                throw new Error(`FlowLogger allows maximum of 32 log levels`);
            this.to_id[level] = 1 << this.level_bits++;
            this.to_color[level] = color;
            if (level == 'trace') // see FlowLogger::trace()
                return;
            this[level] = (...args) => { return this.log_(level, ...args); };
            this[level].trace = (...args) => {
                var _a;
                this.log_(level, ...args);
                (_a = (new Error()).stack) === null || _a === void 0 ? void 0 : _a.split('\n').slice(2).forEach(l => this.log_(level, l));
                return this;
            };
        });
        return this;
    }
    levels_to_ui32(levels) {
        return levels.reduce((v, l) => v | this.to_id[l], 0);
    }
    setLevel(levels) {
        if (levels == 'none')
            return this.disable('all');
        return this.disable('all').enable(levels);
    }
    enable(levels) {
        if (levels == 'all') {
            this.levels_ui32_ = 0xffffffff;
            return this;
        }
        Object.entries(this.to_id).forEach(([l, bit]) => {
            if (levels.includes(l))
                this.levels_ui32_ |= bit;
            else if (this.to_id[l] === undefined)
                throw new Error(`FlowLogger::enable() - unknown log level "${l}"`);
        });
        return this;
    }
    disable(levels) {
        if (levels == 'all') {
            this.levels_ui32_ = 0x00000000;
            return this;
        }
        Object.entries(this.to_id).forEach(([l, bit]) => {
            if (levels.includes(l))
                this.levels_ui32_ &= ~bit;
        });
        return this;
    }
    relayTo(sink) {
        this.sink = sink;
    }
    log_(level, ...args) {
        let id = this.to_id[level];
        if (!(this.levels_ui32_ & id))
            return this;
        const ts = FlowLogger.getTS();
        if (this.sink && !this.sink({ ts, level, args }))
            return this;
        const { prefix_color_ui32: prefix_color, prefix_ui32 } = this;
        if (isNODE) {
            const prefix = [];
            if (prefix_ui32 & time_prefix) {
                prefix.push(prefix_color & time_prefix ? ansi_color(ts, level) : ts);
            }
            if (prefix_ui32 & name_prefix) {
                const p = (this.name_prefix_ + ((prefix_ui32 & level_prefix) ? '' : ':'));
                prefix.push(prefix_color & name_prefix ? ansi_color(p, level) : p);
            }
            if (prefix_ui32 & level_prefix) {
                const l = (level + ':');
                prefix.push(prefix_color & level_prefix ? ansi_color(l, level) : l);
            }
            if (this.color_content) {
                args = args.map((v) => {
                    return typeof v === 'string' ? ansi_color(v, level) : v;
                });
            }
            console.log(...prefix, ...args);
        }
        else {
            const prefix = [];
            const colors = [];
            const color_ = 'color:' + this.to_color[level];
            const color_default = 'color:white';
            if (prefix_ui32 & time_prefix) {
                prefix.push('%c' + ts);
                if (prefix_color & time_prefix) {
                    colors.push(color_);
                }
                else {
                    colors.push(color_default);
                }
            }
            if (prefix_ui32 & name_prefix) {
                const p = (this.name_prefix_ + ((prefix_ui32 & level_prefix) ? '' : ':'));
                prefix.push('%c' + p);
                if (prefix_color & name_prefix) {
                    colors.push(color_);
                }
                else {
                    colors.push(color_default);
                }
            }
            if (prefix_ui32 & level_prefix) {
                prefix.push(`%c${level}:`);
                if (prefix_color & level_prefix) {
                    colors.push(color_);
                }
                else {
                    colors.push(color_default);
                }
            }
            /*
            args = args.map((arg) => {
                if(typeof arg == 'string') {
                    colors.push(color_);
                    return '%c'+arg;
                }
                else
                    return arg;
            });
            */
            console.log(prefix.join(" "), ...colors, ...args);
            return this;
        }
        return this;
    }
    trace(...args) {
        var _a;
        this.log_('trace', ...args);
        (_a = (new Error()).stack) === null || _a === void 0 ? void 0 : _a.split('\n').slice(2).forEach(l => this.log_('trace', l));
        //.forEach(l=>this.log_(level,l));
        return this;
    }
    tag(subject) {
        this.profiles[subject] = Date.now();
    }
    profile(subject, ...args) {
        const ts1 = Date.now();
        const ts0 = this.profiles[subject];
        delete this.profiles[subject];
        const delta = ts1 - ts0;
        this.log_('profile', delta, ...args);
        return delta;
    }
}
exports.FlowLogger = FlowLogger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxvdy1sb2dnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvZmxvdy1sb2dnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7RUFZRTs7O0FBR0YsSUFBSSxNQUFVLENBQUM7QUFFZixhQUFhO0FBQ2IsSUFBSSxNQUFNLEdBQUcsT0FBTyxNQUFNLElBQUksV0FBVztJQUNyQyxhQUFhO09BQ1YsT0FBTyxPQUFPLEtBQUssUUFBUTtJQUM5QixhQUFhO09BQ1YsR0FBRyxPQUFPLEVBQUUsS0FBSyxrQkFBa0I7SUFDdEMsYUFBYTtPQUNWLE9BQU8sT0FBTyxJQUFJLFVBQVUsQ0FBQztBQUVwQyxhQUFhO0FBQ2IsSUFBRyxNQUFNLElBQUksT0FBTyxFQUFFLEtBQUssV0FBVztJQUNsQyxNQUFNLEdBQUcsS0FBSyxDQUFDO0FBRW5CLElBQUcsTUFBTSxFQUFDO0lBQ04sYUFBYTtJQUNiLE1BQU0sR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztDQUM1QztBQUVELFNBQVMsVUFBVSxDQUFDLElBQVcsRUFBRSxLQUFZO0lBQ3pDLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUMsSUFBSSxDQUFDLENBQUM7QUFDckMsQ0FBQztBQUVELFNBQVMsS0FBSyxDQUFDLEtBQWlDO0lBQzVDLElBQUcsTUFBTSxJQUFJLE1BQU0sRUFBRTtRQUNqQixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3ZCO0FBQ0wsQ0FBQztBQWFELElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQztBQUNuQixNQUFNLFFBQVEsR0FBWTtJQUN4QixNQUFNLEVBQUcsQ0FBQyxJQUFJLFVBQVUsRUFBRTtJQUMxQixNQUFNLEVBQUcsQ0FBQyxJQUFJLFVBQVUsRUFBRTtJQUMxQixPQUFPLEVBQUUsQ0FBQyxJQUFJLFVBQVUsRUFBRTtDQUMzQixDQUFBO0FBRUQsTUFBTSxFQUNGLElBQUksRUFBRyxXQUFX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bkMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzlCLE1BQU0sS0FBSyxHQUFHLEdBQUcsR0FBQyxHQUFHLENBQUM7UUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDckMsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztDQUVKO0FBelBELGdDQXlQQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcblxyXG5Vc2FnZSBleGFtcGxlOlxyXG5cclxuY29uc3QgbG9nID0gbmV3IEZsb3dMb2dnZXIoJ1Rlc3RMb2dnZXInLCB7IGRpc3BsYXkgOiBbJ25hbWUnLCdsZXZlbCddLCBjdXN0b20gOiBbJ2xldmVsQTpjeWFuJywnbGV2ZWxCJ10sIGNvbG9yOiAnbmFtZSBsZXZlbCcgfSk7XHJcbmxvZy5sZXZlbHMuZW5hYmxlKCdsZXZlbEEgbGV2ZWxCJyk7XHJcbmxvZy5pbmZvKCdpbmZvIGxvZycpO1xyXG5sb2cuaW5mby50cmFjZSgnaW5mbyB0cmFjZScpOyAgLy8gcHJpbnRzIHN0YWNrIHRyYWNlXHJcbmxvZy5sZXZlbHMuZGlzYWJsZSgnYWxsJykuZW5hYmxlKCdkZWJ1ZyB0cmFjZScpO1xyXG5sb2cudHJhY2UoJ3RyYWNlIHRlc3QpO1xyXG5sb2cuZGVidWcoJ2RlYnVnIHRlc3QpO1xyXG5cclxuKi9cclxuXHJcblxyXG5sZXQgQ29sb3JzOmFueTtcclxuXHJcbi8vIEB0cy1pZ25vcmVcclxubGV0IGlzTk9ERSA9IHR5cGVvZiB3aW5kb3cgPT0gJ3VuZGVmaW5lZCcgXHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAmJiB0eXBlb2YgcHJvY2VzcyA9PT0gXCJvYmplY3RcIiBcclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICYmIGAke3Byb2Nlc3N9YCA9PT0gXCJbb2JqZWN0IHByb2Nlc3NdXCIgXHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAmJiB0eXBlb2YgcmVxdWlyZSA9PSAnZnVuY3Rpb24nO1xyXG5cclxuLy8gQHRzLWlnbm9yZVxyXG5pZihpc05PREUgJiYgdHlwZW9mIG53ICE9PSAndW5kZWZpbmVkJylcclxuICAgIGlzTk9ERSA9IGZhbHNlO1xyXG5cclxuaWYoaXNOT0RFKXtcclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgIENvbG9ycyA9IHJlcXVpcmUoJ0Bhc3BlY3Ryb24vY29sb3JzLnRzJyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFuc2lfY29sb3IodGV4dDpzdHJpbmcsIGNvbG9yOnN0cmluZykge1xyXG4gICAgcmV0dXJuIENvbG9ycy5jb2xvcnMoY29sb3IsdGV4dCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRoZW1lKHRoZW1lOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZzsgfSkge1xyXG4gICAgaWYoaXNOT0RFICYmIENvbG9ycykge1xyXG4gICAgICAgIENvbG9ycy50aGVtZSh0aGVtZSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIENvbG9yYWJsZSA9ICd0aW1lJ3wnbmFtZSd8J2xldmVsJ3wnY29udGVudCd8J3ByZWZpeCd8J2FsbCc7XHJcbmV4cG9ydCB0eXBlIERpc3BsYXlhYmxlID0gJ3RpbWUnfCduYW1lJ3wnbGV2ZWwnfCdhbGwnO1xyXG5leHBvcnQgaW50ZXJmYWNlIExvZ0xldmVsVG9JZCB7IFtrZXk6IHN0cmluZ10gOiBudW1iZXI7IH1cclxuZXhwb3J0IGludGVyZmFjZSBMb2dMZXZlbFRvQ29sb3IgeyBba2V5OiBzdHJpbmddIDogc3RyaW5nOyB9XHJcbmV4cG9ydCBpbnRlcmZhY2UgUHJvZmlsZU1hcCB7IFtrZXk6IHN0cmluZ10gOiBudW1iZXI7IH1cclxuZXhwb3J0IGRlY2xhcmUgdHlwZSBTaW5rRm4gPSAob2JqOiBhbnkpID0+IGJvb2xlYW47XHJcblxyXG5pbnRlcmZhY2UgUHJlZml4SWQge1xyXG4gICAgW2tleTogc3RyaW5nXSA6IG51bWJlcjtcclxufVxyXG5cclxubGV0IHByZWZpeF9pZHMgPSAwO1xyXG5jb25zdCBwcmVmaXhlczpQcmVmaXhJZCA9IHtcclxuICAndGltZScgOiAxIDw8IHByZWZpeF9pZHMrKyxcclxuICAnbmFtZScgOiAxIDw8IHByZWZpeF9pZHMrKyxcclxuICAnbGV2ZWwnOiAxIDw8IHByZWZpeF9pZHMrK1xyXG59XHJcblxyXG5jb25zdCB7XHJcbiAgICB0aW1lIDogdGltZV9wcmVmaXgsXHJcbiAgICBuYW1lIDogbmFtZV9wcmVmaXgsXHJcbiAgICBsZXZlbCA6IGxldmVsX3ByZWZpeFxyXG59ID0gcHJlZml4ZXM7XHJcblxyXG5jb25zdCBsZXZlbHMgPSB7XHJcbiAgICBlcnJvcjogJ3JlZCcsXHJcbiAgICB3YXJuOiAnbWFnZW50YScsXHJcbiAgICBpbmZvOiAnd2hpdGUnLFxyXG4gICAgdmVyYm9zZTogJ3llbGxvdycsXHJcbiAgICBuZXR3b3JrIDogJ2JsdWUnLFxyXG4gICAgcHJvZmlsZSA6ICdjeWFuJyxcclxuICAgIHRyYWNlOiAnZ3JleScsXHJcbiAgICBkZWJ1ZzogJ2dyZWVuJyxcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGbG93TG9nZ2VyT3B0aW9uc3tcclxuICAgIHNpbms/IDogU2lua0ZuLCAgICAgLy8gY2FsbGJhY2sgdG8gcmVjZWl2ZSBtZXNzYWdlc1xyXG4gICAgbGV2ZWxzPyA6IHN0cmluZ1tdLCAgIC8vIGxldmVscyB0byBlbmFibGUgYnkgZGVmYXVsdFxyXG4gICAgZGlzcGxheT8gOiBEaXNwbGF5YWJsZVtdLCAgIC8vIHBhcnQgb2YgdGhlIHByZWZpeCB0byBkaXNwbGF5OiB0aW1lfG5hbWV8bGV2ZWxcclxuICAgIGN1c3RvbT8gOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+fHN0cmluZ1tdLCAvLyBjdXN0b20gbG9nIGxldmVscyBhcyB7IGFiYyA6ICdjeWFuJywgZGVmIDogJ2JsdWUgfSBvciBbJ2FiYzpjeWFuJywnZGVmOmJsdWUnXVxyXG4gICAgY29sb3I/IDogQ29sb3JhYmxlW10gLy8gY29tcG9uZW50IHRvIGNvbG9yIHRpbWV8bmFtZXxsZXZlbHxjb250ZW50XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRmxvd0xvZ2dlck9wdHtcclxuICAgIHNpbms/IDogU2lua0ZuLFxyXG4gICAgbGV2ZWxzOiBzdHJpbmdbXSxcclxuICAgIGRpc3BsYXkgOiBEaXNwbGF5YWJsZVtdLFxyXG4gICAgY3VzdG9tIDogUmVjb3JkPHN0cmluZywgc3RyaW5nPnxzdHJpbmdbXSxcclxuICAgIGNvbG9yIDogQ29sb3JhYmxlW11cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEZsb3dMb2dnZXIge1xyXG5cclxuICAgIFtrZXk6c3RyaW5nXTphbnk7XHJcbiAgICBwcmVmaXhfdWkzMjpudW1iZXI7XHJcbiAgICBwcmVmaXhfY29sb3JfdWkzMjpudW1iZXI7XHJcbiAgICBjb2xvcl9jb250ZW50OmJvb2xlYW47XHJcbiAgICBsZXZlbF9iaXRzOm51bWJlcjtcclxuICAgIHRvX2lkOiBMb2dMZXZlbFRvSWQ7XHJcbiAgICB0b19jb2xvcjogTG9nTGV2ZWxUb0NvbG9yO1xyXG4gICAgbGV2ZWxzX3VpMzJfOm51bWJlcjtcclxuICAgIHNpbms6U2lua0ZufHVuZGVmaW5lZDtcclxuICAgIHByb2ZpbGVzOlByb2ZpbGVNYXA7XHJcblxyXG4gICAgLy9bZm46c3RyaW5nXSA6IGxvZ2ZuO1xyXG5cclxuICAgIHN0YXRpYyBnZXRUUygpOnN0cmluZyB7XHJcbiAgICAgICAgbGV0IGQ6RGF0ZSA9IChuZXcgRGF0ZSgpKTtcclxuICAgICAgICBsZXQgeWVhcjpzdHJpbmd8bnVtYmVyID0gZC5nZXRGdWxsWWVhcigpO1xyXG4gICAgICAgIGxldCBtb250aDpzdHJpbmd8bnVtYmVyID0gZC5nZXRNb250aCgpKzE7IG1vbnRoID0gbW9udGggPCAxMCA/ICcwJyArIG1vbnRoIDogbW9udGg7XHJcbiAgICAgICAgbGV0IGRhdGU6c3RyaW5nfG51bWJlciA9IGQuZ2V0RGF0ZSgpOyBkYXRlID0gZGF0ZSA8IDEwID8gJzAnICsgZGF0ZSA6IGRhdGU7XHJcbiAgICAgICAgbGV0IGhvdXI6c3RyaW5nfG51bWJlciA9IGQuZ2V0SG91cnMoKTsgaG91ciA9IGhvdXIgPCAxMCA/ICcwJyArIGhvdXIgOiBob3VyO1xyXG4gICAgICAgIGxldCBtaW46c3RyaW5nfG51bWJlciA9IGQuZ2V0TWludXRlcygpOyBtaW4gPSBtaW4gPCAxMCA/ICcwJyArIG1pbiA6IG1pbjtcclxuICAgICAgICBsZXQgc2VjOnN0cmluZ3xudW1iZXIgPSBkLmdldFNlY29uZHMoKTsgc2VjID0gc2VjIDwgMTAgPyAnMCcgKyBzZWMgOiBzZWM7XHJcbiAgICAgICAgLy92YXIgdGltZSA9IHllYXIgKyAnLScgKyBtb250aCArICctJyArIGRhdGUgKyAnICcgKyBob3VyICsgJzonICsgbWluICsgJzonICsgc2VjO1xyXG4gICAgICAgIHJldHVybiBgJHt5ZWFyfS0ke21vbnRofS0ke2RhdGV9ICR7aG91cn06JHttaW59OiR7c2VjfWA7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGNvbnN0cnVjdG9yKG5hbWU6c3RyaW5nLCBvcHRpb25zOkZsb3dMb2dnZXJPcHRpb25zPXt9KSB7XHJcbiAgICAgICAgaWYodHlwZW9mIG5hbWUgIT0gJ3N0cmluZycpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmxvd0xvZ2dlcjo6Y29uc3RydWN0b3IoKSAtIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcnKTtcclxuXHJcbiAgICAgICAgbGV0IG9wdDpGbG93TG9nZ2VyT3B0ID0gT2JqZWN0LmFzc2lnbih7XHJcbiAgICAgICAgICAgIHNpbmsgOiBudWxsLCAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbGxiYWNrIHRvIHJlY2VpdmUgbWVzc2FnZXNcclxuICAgICAgICAgICAgbGV2ZWxzIDogWydlcnJvcicsJ3dhcm4nLCdpbmZvJ10sICAgLy8gbGV2ZWxzIHRvIGVuYWJsZSBieSBkZWZhdWx0XHJcbiAgICAgICAgICAgIGRpc3BsYXk6IFsnbGV2ZWwnXSwgICAgICAgICAgICAgICAgIC8vIHBhcnQgb2YgdGhlIHByZWZpeCB0byBkaXNwbGF5OiB0aW1lfG5hbWV8bGV2ZWxcclxuICAgICAgICAgICAgY3VzdG9tIDogeyB9LCAgICAgICAgICAgICAgICAgICAgICAgLy8gY3VzdG9tIGxvZyBsZXZlbHMgYXMgeyBhYmMgOiAnY3lhbicsIGRlZiA6ICdibHVlIH0gb3IgWydhYmM6Y3lhbicsJ2RlZjpibHVlJ11cclxuICAgICAgICAgICAgY29sb3IgOiBbJ25hbWUnLCdsZXZlbCddICAgICAgICAgICAgLy8gY29tcG9uZW50IHRvIGNvbG9yIHRpbWV8bmFtZXxsZXZlbHxjb250ZW50XHJcbiAgICAgICAgfSwgb3B0aW9ucyk7XHJcblxyXG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XHJcbiAgICAgICAgdGhpcy5uYW1lX3ByZWZpeF8gPSBgWyR7bmFtZX1dYDtcclxuXHJcbiAgICAgICAgdGhpcy5sZXZlbF9iaXRzID0gMDtcclxuICAgICAgICB0aGlzLnRvX2lkID0geyB9XHJcbiAgICAgICAgdGhpcy50b19jb2xvciA9IHsgfVxyXG4gICAgICAgIHRoaXMubGV2ZWxzX3VpMzJfID0gMDtcclxuICAgICAgICB0aGlzLnByZWZpeF9jb2xvcl91aTMyID0gMDtcclxuICAgICAgICB0aGlzLnByb2ZpbGVzID0ge307XHJcblxyXG4gICAgICAgIGxldCBjdXN0b206YW55ID0geyB9XHJcbiAgICAgICAgaWYoQXJyYXkuaXNBcnJheShvcHQuY3VzdG9tKSlcclxuICAgICAgICAgICAgb3B0LmN1c3RvbS5mb3JFYWNoKGw9PntcclxuICAgICAgICAgICAgICAgIGxldCBbbGV2ZWwsY29sb3JdID0gbC5zcGxpdCgnOicpO1xyXG4gICAgICAgICAgICAgICAgY3VzdG9tW2xldmVsXT1jb2xvcnx8J3doaXRlJztcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICBjdXN0b20gPSBvcHQuY3VzdG9tO1xyXG5cclxuICAgICAgICB0aGlzLnNpbmsgPSBvcHQuc2luaztcclxuXHJcbiAgICAgICAgdGhpcy5jcmVhdGUoe1xyXG4gICAgICAgICAgICAuLi5sZXZlbHMsXHJcbiAgICAgICAgICAgIC4uLmN1c3RvbVxyXG4gICAgICAgIH0pLmVuYWJsZShvcHQubGV2ZWxzKS5lbmFibGUoT2JqZWN0LmtleXMoY3VzdG9tKSk7XHJcblxyXG4gICAgICAgIGlmKG9wdC5jb2xvcilcclxuICAgICAgICAgICAgdGhlbWUodGhpcy50b19jb2xvcik7XHJcblxyXG4gICAgICAgIHRoaXMucHJlZml4X3VpMzIgPSBvcHQuZGlzcGxheS5yZWR1Y2UoKHYsbCk9PnZ8cHJlZml4ZXNbbF0sMCk7XHJcblxyXG4gICAgICAgIHRoaXMucHJlZml4X2NvbG9yX3VpMzIgPSAwO1xyXG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHByZWZpeGVzKS5mb3JFYWNoKChbcHJlZml4LCBiaXRdKSA9PiB7XHJcbiAgICAgICAgICAgIGlmKG9wdC5jb2xvci5pbmNsdWRlcyhwcmVmaXggYXMgQ29sb3JhYmxlKSB8fCBvcHQuY29sb3IuaW5jbHVkZXMoJ3ByZWZpeCcpIHx8IG9wdC5jb2xvci5pbmNsdWRlcygnYWxsJykpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnByZWZpeF9jb2xvcl91aTMyIHw9IGJpdDtcclxuICAgICAgICB9KVxyXG4gICAgICAgIHRoaXMuY29sb3JfY29udGVudCA9IG9wdC5jb2xvci5pbmNsdWRlcygnY29udGVudCcpIHx8IG9wdC5jb2xvci5pbmNsdWRlcygnYWxsJyk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGNyZWF0ZShkZXNjcmlwdG9yOltzdHJpbmcsc3RyaW5nXSkge1xyXG4gICAgICAgIE9iamVjdC5lbnRyaWVzKGRlc2NyaXB0b3IpLmZvckVhY2goKFtsZXZlbCwgY29sb3JdOltzdHJpbmcsc3RyaW5nXSkgPT4ge1xyXG4gICAgICAgICAgICBpZih0aGlzLmxldmVsX2JpdHMgPiAzMilcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmxvd0xvZ2dlciBhbGxvd3MgbWF4aW11bSBvZiAzMiBsb2cgbGV2ZWxzYCk7XHJcbiAgICAgICAgICAgIHRoaXMudG9faWRbbGV2ZWxdID0gMSA8PCB0aGlzLmxldmVsX2JpdHMrKztcclxuICAgICAgICAgICAgdGhpcy50b19jb2xvcltsZXZlbF0gPSBjb2xvcjtcclxuICAgICAgICAgICAgaWYobGV2ZWwgPT0gJ3RyYWNlJykgICAgLy8gc2VlIEZsb3dMb2dnZXI6OnRyYWNlKClcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgdGhpc1tsZXZlbF0gPSAoLi4uYXJnczphbnlbXSk6IEZsb3dMb2dnZXIgPT4geyByZXR1cm4gdGhpcy5sb2dfKGxldmVsLCAuLi5hcmdzKTsgfVxyXG4gICAgICAgICAgICB0aGlzW2xldmVsXS50cmFjZSA9ICguLi5hcmdzOmFueVtdKTogRmxvd0xvZ2dlciA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ18obGV2ZWwsIC4uLmFyZ3MpO1xyXG4gICAgICAgICAgICAgICAgKG5ldyBFcnJvcigpKS5zdGFjaz8uc3BsaXQoJ1xcbicpLnNsaWNlKDIpLmZvckVhY2gobD0+dGhpcy5sb2dfKGxldmVsLGwpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBsZXZlbHNfdG9fdWkzMihsZXZlbHM6c3RyaW5nW10pIHtcclxuICAgICAgICByZXR1cm4gbGV2ZWxzLnJlZHVjZSgodjpudW1iZXIsbDpzdHJpbmcpPT52fHRoaXMudG9faWRbbF0sMCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0TGV2ZWwobGV2ZWxzOnN0cmluZ3xzdHJpbmdbXSl7XHJcbiAgICAgICAgaWYobGV2ZWxzID09ICdub25lJylcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGlzYWJsZSgnYWxsJylcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzYWJsZSgnYWxsJykuZW5hYmxlKGxldmVscyk7XHJcbiAgICB9XHJcblxyXG4gICAgZW5hYmxlKGxldmVsczpzdHJpbmd8c3RyaW5nW10pOkZsb3dMb2dnZXIge1xyXG4gICAgICAgIGlmKGxldmVscyA9PSAnYWxsJykge1xyXG4gICAgICAgICAgICB0aGlzLmxldmVsc191aTMyXyA9IDB4ZmZmZmZmZmY7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgT2JqZWN0LmVudHJpZXModGhpcy50b19pZCkuZm9yRWFjaCgoW2wsYml0XSkgPT4ge1xyXG4gICAgICAgICAgICBpZihsZXZlbHMuaW5jbHVkZXMobCkpXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxldmVsc191aTMyXyB8PSBiaXQ7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgaWYodGhpcy50b19pZFtsXSA9PT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGbG93TG9nZ2VyOjplbmFibGUoKSAtIHVua25vd24gbG9nIGxldmVsIFwiJHtsfVwiYCk7XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgZGlzYWJsZShsZXZlbHM6c3RyaW5nfHN0cmluZ1tdKTpGbG93TG9nZ2VyIHtcclxuICAgICAgICBpZihsZXZlbHMgPT0gJ2FsbCcpIHtcclxuICAgICAgICAgICAgdGhpcy5sZXZlbHNfdWkzMl8gPSAweDAwMDAwMDAwO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHRoaXMudG9faWQpLmZvckVhY2goKFtsLGJpdF0pID0+IHtcclxuICAgICAgICAgICAgaWYobGV2ZWxzLmluY2x1ZGVzKGwpKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5sZXZlbHNfdWkzMl8gJj0gfmJpdDtcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICByZWxheVRvKHNpbms6U2lua0ZuKSB7XHJcbiAgICAgICAgdGhpcy5zaW5rID0gc2luaztcclxuICAgIH1cclxuXHJcbiAgICBsb2dfKGxldmVsOnN0cmluZywgLi4uYXJnczphbnlbXSk6IEZsb3dMb2dnZXIge1xyXG5cclxuICAgICAgICBsZXQgaWQgPSB0aGlzLnRvX2lkW2xldmVsXTtcclxuICAgICAgICBpZighKHRoaXMubGV2ZWxzX3VpMzJfICYgaWQpKVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcclxuXHJcbiAgICAgICAgY29uc3QgdHMgPSBGbG93TG9nZ2VyLmdldFRTKCk7XHJcblxyXG4gICAgICAgIGlmKHRoaXMuc2luayAmJiAhdGhpcy5zaW5rKHt0cyxsZXZlbCxhcmdzfSkpXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIGNvbnN0IHtwcmVmaXhfY29sb3JfdWkzMjpwcmVmaXhfY29sb3IsIHByZWZpeF91aTMyfSA9IHRoaXM7XHJcblxyXG4gICAgICAgIGlmKGlzTk9ERSkge1xyXG4gICAgICAgICAgICBjb25zdCBwcmVmaXg6c3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgIGlmKHByZWZpeF91aTMyICYgdGltZV9wcmVmaXgpIHtcclxuICAgICAgICAgICAgICAgIHByZWZpeC5wdXNoKHByZWZpeF9jb2xvciAmIHRpbWVfcHJlZml4ID8gYW5zaV9jb2xvcih0cyxsZXZlbCkgOiB0cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYocHJlZml4X3VpMzIgJiBuYW1lX3ByZWZpeCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcDpzdHJpbmcgPSAodGhpcy5uYW1lX3ByZWZpeF8rKChwcmVmaXhfdWkzMiAmIGxldmVsX3ByZWZpeCk/Jyc6JzonKSk7XHJcbiAgICAgICAgICAgICAgICBwcmVmaXgucHVzaChwcmVmaXhfY29sb3ImbmFtZV9wcmVmaXg/YW5zaV9jb2xvcihwLGxldmVsKTpwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihwcmVmaXhfdWkzMiAmIGxldmVsX3ByZWZpeCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbDpzdHJpbmcgPSAobGV2ZWwrJzonKTtcclxuICAgICAgICAgICAgICAgIHByZWZpeC5wdXNoKHByZWZpeF9jb2xvciZsZXZlbF9wcmVmaXg/YW5zaV9jb2xvcihsLGxldmVsKTpsKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYodGhpcy5jb2xvcl9jb250ZW50KSB7XHJcbiAgICAgICAgICAgICAgICBhcmdzID0gYXJncy5tYXAoKHY6YW55W3N0cmluZ10pPT57XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiB2ID09PSAnc3RyaW5nJyA/IGFuc2lfY29sb3IodixsZXZlbCkgOiB2O1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc29sZS5sb2coLi4ucHJlZml4LCAuLi5hcmdzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCBjb2xvcnMgPSBbXTtcclxuICAgICAgICAgICAgY29uc3QgY29sb3JfID0gJ2NvbG9yOicrdGhpcy50b19jb2xvcltsZXZlbF07XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbG9yX2RlZmF1bHQgPSAnY29sb3I6d2hpdGUnO1xyXG5cclxuICAgICAgICAgICAgaWYocHJlZml4X3VpMzIgJiB0aW1lX3ByZWZpeCkge1xyXG4gICAgICAgICAgICAgICAgcHJlZml4LnB1c2goJyVjJyt0cyk7XHJcbiAgICAgICAgICAgICAgICBpZihwcmVmaXhfY29sb3IgJiB0aW1lX3ByZWZpeCl7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sb3JzLnB1c2goY29sb3JfKVxyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sb3JzLnB1c2goY29sb3JfZGVmYXVsdClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihwcmVmaXhfdWkzMiAmIG5hbWVfcHJlZml4KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwID0gKHRoaXMubmFtZV9wcmVmaXhfKygocHJlZml4X3VpMzIgJiBsZXZlbF9wcmVmaXgpPycnOic6JykpO1xyXG4gICAgICAgICAgICAgICAgcHJlZml4LnB1c2goJyVjJytwKTtcclxuICAgICAgICAgICAgICAgIGlmKHByZWZpeF9jb2xvciAmIG5hbWVfcHJlZml4KXtcclxuICAgICAgICAgICAgICAgICAgICBjb2xvcnMucHVzaChjb2xvcl8pXHJcbiAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICBjb2xvcnMucHVzaChjb2xvcl9kZWZhdWx0KVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKHByZWZpeF91aTMyICYgbGV2ZWxfcHJlZml4KSB7XHJcbiAgICAgICAgICAgICAgICBwcmVmaXgucHVzaChgJWMke2xldmVsfTpgKTtcclxuICAgICAgICAgICAgICAgIGlmKHByZWZpeF9jb2xvciAmIGxldmVsX3ByZWZpeCl7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sb3JzLnB1c2goY29sb3JfKVxyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sb3JzLnB1c2goY29sb3JfZGVmYXVsdClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgYXJncyA9IGFyZ3MubWFwKChhcmcpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBhcmcgPT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb2xvcnMucHVzaChjb2xvcl8pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnJWMnK2FyZztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJnO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgY29uc29sZS5sb2cocHJlZml4LmpvaW4oXCIgXCIpLCAuLi5jb2xvcnMsIC4uLmFyZ3MpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICB0cmFjZSguLi5hcmdzOmFueVtdKSB7XHJcbiAgICAgICAgdGhpcy5sb2dfKCd0cmFjZScsIC4uLmFyZ3MpO1xyXG4gICAgICAgIChuZXcgRXJyb3IoKSkuc3RhY2s/LnNwbGl0KCdcXG4nKS5zbGljZSgyKS5mb3JFYWNoKGw9PnRoaXMubG9nXygndHJhY2UnLGwpKTtcclxuICAgICAgICAvLy5mb3JFYWNoKGw9PnRoaXMubG9nXyhsZXZlbCxsKSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgdGFnKHN1YmplY3Q6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMucHJvZmlsZXNbc3ViamVjdF0gPSBEYXRlLm5vdygpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb2ZpbGUoc3ViamVjdDogc3RyaW5nLCAuLi5hcmdzOmFueVtdKSB7XHJcbiAgICAgICAgY29uc3QgdHMxID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBjb25zdCB0czAgPSB0aGlzLnByb2ZpbGVzW3N1YmplY3RdO1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLnByb2ZpbGVzW3N1YmplY3RdO1xyXG4gICAgICAgIGNvbnN0IGRlbHRhID0gdHMxLXRzMDtcclxuICAgICAgICB0aGlzLmxvZ18oJ3Byb2ZpbGUnLCBkZWx0YSwgLi4uYXJncyk7XHJcbiAgICAgICAgcmV0dXJuIGRlbHRhO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=