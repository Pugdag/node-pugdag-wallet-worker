"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RPC = exports.Client = exports.UID = void 0;
const UID = () => (Math.random() * 100000).toFixed(0) + Date.now();
exports.UID = UID;
class Client {
    constructor(core, options = {}) {
        this.callbacks = new Map();
        this.subscribers = new Map();
        this.pending = new Map();
        this.verbose = false;
        this.core = core;
        this.log = Function.prototype.bind.call(console.log, console, `[Pugdag gRPCProxy]:`);
        //seperate callback for direct function
        this.core.on('rpc-direct', (msg) => {
            const { rid, result } = msg;
            let CB = this.callbacks.get(rid);
            this.log("rpc-direct", rid, result, CB);
            if (!CB)
                return;
            CB(result);
        });
        this.core.on('rpc-response', (msg) => {
            const { rid, result, error } = msg;
            let pending = this.pending.get(rid);
            if (!pending)
                return;
            pending.cb(error, result);
            this.pending.delete(rid);
        });
        this.core.on('rpc-publish', (msg) => {
            const { result, method } = msg;
            let eventName = this.subject2EventName(method);
            this.verbose && this.log("subscribe:eventName", eventName);
            let subscribers = this.subscribers.get(eventName);
            if (!subscribers || !subscribers.length)
                return;
            subscribers.map(subscriber => {
                subscriber.callback(result);
            });
        });
    }
    cleanup() {
        this.callbacks.clear();
        this.subscribers.clear();
        this.pending.clear();
    }
    addCB(key, cb) {
        let uid = (0, exports.UID)();
        this.callbacks.set(uid, cb);
        return uid;
    }
    req(fn, args, rid = '') {
        this.core.postMessage("rpc-request", { fn, args, rid });
    }
    call(method, data = {}, type = "request", uid = undefined) {
        return new Promise((resolve, reject) => {
            let rid = uid || (0, exports.UID)();
            this.pending.set(rid, {
                method,
                cb: (error, result = undefined) => {
                    if (error)
                        return reject(error);
                    resolve(result);
                }
            });
            this.req(type, [method, data], rid);
        });
    }
    onConnect(callback) {
        let rid = this.addCB("onConnect", callback);
        this.req("onConnect", [], rid);
    }
    onDisconnect(callback) {
        let rid = this.addCB("onDisconnect", callback);
        this.req("onDisconnect", [], rid);
    }
    onConnectFailure(callback) {
        let rid = this.addCB("onConnectFailure", callback);
        this.req("onConnectFailure", [], rid);
    }
    onError(callback) {
        let rid = this.addCB("onError", callback);
        this.req("onError", [], rid);
    }
    disconnect() {
        this.req("disconnect", []);
    }
    connect() {
        this.req("connect", []);
    }
    subscribe(subject, data, callback) {
        let eventName = this.subject2EventName(subject);
        this.verbose && this.log("subscribe:eventName", eventName);
        let subscribers = this.subscribers.get(eventName);
        if (!subscribers) {
            subscribers = [];
            this.subscribers.set(eventName, subscribers);
        }
        let uid = (0, exports.UID)();
        subscribers.push({ uid, callback });
        let p = this.call(subject, data, "subscribe", uid);
        p.uid = uid;
        return p;
    }
    subject2EventName(subject) {
        let eventName = subject.replace("notify", "").replace("Request", "Notification");
        return eventName[0].toLowerCase() + eventName.substr(1);
    }
    unSubscribe(subject, uid = '') {
        this.req("unSubscribe", [subject, uid]);
        let eventName = this.subject2EventName(subject);
        let subscribers = this.subscribers.get(eventName);
        if (!subscribers)
            return;
        if (!uid) {
            this.subscribers.delete(eventName);
        }
        else {
            subscribers = subscribers.filter(sub => sub.uid != uid);
            this.subscribers.set(eventName, subscribers);
        }
    }
}
exports.Client = Client;
class RPC {
    cleanup() {
        this.client.cleanup();
    }
    constructor(options = {}) {
        this.client = options.client;
    }
    onConnect(callback) {
        this.client.onConnect(callback);
    }
    onConnectFailure(callback) {
        this.client.onConnectFailure(callback);
    }
    onError(callback) {
        this.client.onError(callback);
    }
    onDisconnect(callback) {
        this.client.onDisconnect(callback);
    }
    disconnect() {
        var _a;
        (_a = this.client) === null || _a === void 0 ? void 0 : _a.disconnect();
    }
    connect() {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            return (_a = this.client) === null || _a === void 0 ? void 0 : _a.connect();
        });
    }
    unSubscribe(method, uid = '') {
        return this.client.unSubscribe(method, uid);
    }
    subscribe(method, data, callback) {
        return this.client.subscribe(method, data, callback);
    }
    request(method, data) {
        return this.client.call(method, data);
    }
    subscribeChainChanged(callback) {
        return this.subscribe("notifyChainChangedRequest", {}, callback);
    }
    subscribeBlockAdded(callback) {
        return this.subscribe("notifyBlockAddedRequest", {}, callback);
    }
    subscribeVirtualSelectedParentBlueScoreChanged(callback) {
        return this.subscribe("notifyVirtualSelectedParentBlueScoreChangedRequest", {}, callback);
    }
    subscribeUtxosChanged(addresses, callback) {
        return this.subscribe("notifyUtxosChangedRequest", { addresses }, callback);
    }
    unSubscribeUtxosChanged(uid = '') {
        this.unSubscribe("notifyUtxosChangedRequest", uid);
    }
    getBlock(hash) {
        return this.request('getBlockRequest', { hash, includeBlockVerboseData: true });
    }
    getTransactionsByAddresses(startingBlockHash, addresses) {
        return this.request('getTransactionsByAddressesRequest', {
            startingBlockHash, addresses
        });
    }
    getUtxosByAddresses(addresses) {
        return this.request('getUtxosByAddressesRequest', { addresses });
    }
    submitTransaction(tx) {
        return this.request('submitTransactionRequest', tx);
    }
    getVirtualSelectedParentBlueScore() {
        return this.request('getVirtualSelectedParentBlueScoreRequest', {});
    }
    getBlockDagInfo() {
        return this.request('getBlockDagInfoRequest', {});
    }
    subscribeVirtualDaaScoreChanged(callback) {
        return this.subscribe("notifyVirtualDaaScoreChangedRequest", {}, callback);
    }
}
exports.RPC = RPC;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnBjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3JwYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFHTyxNQUFNLEdBQUcsR0FBRyxHQUFFLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQXZELFFBQUEsR0FBRyxPQUFvRDtBQUlwRSxNQUFhLE1BQU07SUFTbEIsWUFBWSxJQUFlLEVBQUUsVUFBWSxFQUFFO1FBUjNDLGNBQVMsR0FBeUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM1QyxnQkFBVyxHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzFDLFlBQU8sR0FBNkMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUU5RCxZQUFPLEdBQVcsS0FBSyxDQUFDO1FBS3ZCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUN0QyxPQUFPLENBQUMsR0FBRyxFQUNYLE9BQU8sRUFDUCxzQkFBc0IsQ0FDdEIsQ0FBQztRQUVGLHVDQUF1QztRQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxHQUE0QixFQUFDLEVBQUU7WUFDMUQsTUFBTSxFQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUMsR0FBRyxHQUFHLENBQUM7WUFDMUIsSUFBSSxFQUFFLEdBQXNCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BELElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDdkMsSUFBRyxDQUFDLEVBQUU7Z0JBQ0wsT0FBTTtZ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UlBDIGFzIFJwYywgU3Vic2NyaWJlckl0ZW0sIFN1YnNjcmliZXJJdGVtTWFwfSBmcm9tICcuLi90eXBlcy9jdXN0b20tdHlwZXMnO1xuaW1wb3J0IHtXb3JrZXJDb3JlfSBmcm9tICcuL3dvcmtlci1jb3JlJztcbmV4cG9ydCB0eXBlIENCSXRlbSA9IHt1aWQ/OnN0cmluZywgY2I6RnVuY3Rpb259O1xuZXhwb3J0IGNvbnN0IFVJRCA9ICgpPT4oTWF0aC5yYW5kb20oKSoxMDAwMDApLnRvRml4ZWQoMCkrRGF0ZS5ub3coKTtcblxuZXhwb3J0IHtJUlBDfTtcblxuZXhwb3J0IGNsYXNzIENsaWVudHtcblx0Y2FsbGJhY2tzOk1hcDxzdHJpbmcsIEZ1bmN0aW9uPiA9IG5ldyBNYXAoKTtcblx0c3Vic2NyaWJlcnM6U3Vic2NyaWJlckl0ZW1NYXAgPSBuZXcgTWFwKCk7XG5cdHBlbmRpbmc6TWFwPHN0cmluZywge21ldGhvZDpzdHJpbmcsIGNiOkZ1bmN0aW9ufT4gPSBuZXcgTWFwKCk7XG5cblx0dmVyYm9zZTpib29sZWFuID0gZmFsc2U7XG5cdGxvZzpGdW5jdGlvbjtcblx0Y29yZTpXb3JrZXJDb3JlO1xuXG5cdGNvbnN0cnVjdG9yKGNvcmU6V29ya2VyQ29yZSwgb3B0aW9uczphbnk9e30pe1xuXHRcdHRoaXMuY29yZSA9IGNvcmU7XG5cdFx0dGhpcy5sb2cgPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKFxuXHRcdFx0Y29uc29sZS5sb2csXG5cdFx0XHRjb25zb2xlLFxuXHRcdFx0YFtLYXJsc2VuIGdSUENQcm94eV06YFxuXHRcdCk7XG5cblx0XHQvL3NlcGVyYXRlIGNhbGxiYWNrIGZvciBkaXJlY3QgZnVuY3Rpb25cblx0XHR0aGlzLmNvcmUub24oJ3JwYy1kaXJlY3QnLCAobXNnOntyaWQ6c3RyaW5nLCByZXN1bHQ6YW55fSk9Pntcblx0XHRcdGNvbnN0IHtyaWQsIHJlc3VsdH0gPSBtc2c7XG5cdFx0XHRsZXQgQ0I6RnVuY3Rpb258dW5kZWZpbmVkID0gdGhpcy5jYWxsYmFja3MuZ2V0KHJpZCk7XG5cdFx0XHR0aGlzLmxvZyhcInJwYy1kaXJlY3RcIiwgcmlkLCByZXN1bHQsIENCKVxuXHRcdFx0aWYoIUNCKVxuXHRcdFx0XHRyZXR1cm5cblx0XHRcdENCKHJlc3VsdCk7XG5cdFx0fSlcblxuXHRcdHRoaXMuY29yZS5vbigncnBjLXJlc3BvbnNlJywgKG1zZzp7cmlkOnN0cmluZywgcmVzdWx0OmFueSwgZXJyb3I6YW55fSk9Pntcblx0XHRcdGNvbnN0IHtyaWQsIHJlc3VsdCwgZXJyb3J9ID0gbXNnO1xuXHRcdFx0bGV0IHBlbmRpbmc6e21ldGhvZDpzdHJpbmcsIGNiOkZ1bmN0aW9ufXx1bmRlZmluZWQgPSB0aGlzLnBlbmRpbmcuZ2V0KHJpZCk7XG5cdFx0XHRpZighcGVuZGluZylcblx0XHRcdFx0cmV0dXJuXG5cdFx0XHRwZW5kaW5nLmNiKGVycm9yLCByZXN1bHQpO1xuXHRcdFx0XG5cdFx0XHR0aGlzLnBlbmRpbmcuZGVsZXRlKHJpZCk7XG5cdFx0fSlcblxuXHRcdHRoaXMuY29yZS5vbigncnBjLXB1Ymxpc2gnLCAobXNnOntyZXN1bHQ6YW55LCBtZXRob2Q6c3RyaW5nfSk9Pntcblx0XHRcdGNvbnN0IHtyZXN1bHQsIG1ldGhvZH0gPSBtc2c7XG5cdFx0XHRsZXQgZXZlbnROYW1lID0gdGhpcy5zdWJqZWN0MkV2ZW50TmFtZShtZXRob2QpO1xuXHRcdFx0dGhpcy52ZXJib3NlICYmIHRoaXMubG9nKFwic3Vic2NyaWJlOmV2ZW50TmFtZVwiLCBldmVudE5hbWUpXG5cblx0XHRcdGxldCBzdWJzY3JpYmVyczpTdWJzY3JpYmVySXRlbVtdfHVuZGVmaW5lZCA9IHRoaXMuc3Vic2NyaWJlcnMuZ2V0KGV2ZW50TmFtZSk7XG5cdFx0XHRpZighc3Vic2NyaWJlcnMgfHwgIXN1YnNjcmliZXJzLmxlbmd0aClcblx0XHRcdFx0cmV0dXJuXG5cblx0XHRcdHN1YnNjcmliZXJzLm1hcChzdWJzY3JpYmVyPT57XG5cdFx0XHRcdHN1YnNjcmliZXIuY2FsbGJhY2socmVzdWx0KVxuXHRcdFx0fSlcblx0XHR9KVxuXHR9XG5cblx0Y2xlYW51cCgpe1xuXHRcdHRoaXMuY2FsbGJhY2tzLmNsZWFyKCk7XG5cdFx0dGhpcy5zdWJzY3JpYmVycy5jbGVhcigpO1xuXHRcdHRoaXMucGVuZGluZy5jbGVhcigpO1xuXHR9XG5cblx0YWRkQ0Ioa2V5OnN0cmluZywgY2I6RnVuY3Rpb24pe1xuXHRcdGxldCB1aWQgPSBVSUQoKTtcblx0XHR0aGlzLmNhbGxiYWNrcy5zZXQodWlkLCBjYik7XG5cdFx0cmV0dXJuIHVpZDtcblx0fVxuXG5cdHJlcShmbjpzdHJpbmcsIGFyZ3M6YW55W10sIHJpZDpzdHJpbmc9Jycpe1xuXHRcdHRoaXMuY29yZS5wb3N0TWVzc2FnZShcInJwYy1yZXF1ZXN0XCIsIHtmbiwgYXJncywgcmlkfSlcblx0fVxuXG5cdGNhbGwobWV0aG9kOnN0cmluZywgZGF0YTphbnk9e30sIHR5cGU6c3RyaW5nPVwicmVxdWVzdFwiLCB1aWQ6c3RyaW5nfHVuZGVmaW5lZD11bmRlZmluZWQpe1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KT0+e1xuXHRcdFx0bGV0IHJpZCA9IHVpZCB8fCBVSUQoKTtcblx0XHRcdHRoaXMucGVuZGluZy5zZXQocmlkLCB7XG5cdFx0XHRcdG1ldGhvZCxcblx0XHRcdFx0Y2I6KGVycm9yOmFueSwgcmVzdWx0OmFueT11bmRlZmluZWQpPT57XG5cdFx0XHRcdFx0aWYoZXJyb3IpXG5cdFx0XHRcdFx0XHRyZXR1cm4gcmVqZWN0KGVycm9yKTtcblx0XHRcdFx0XHRyZXNvbHZlKHJlc3VsdCk7XG5cdFx0XHRcdH1cblx0XHRcdH0pXG5cdFx0XHR0aGlzLnJlcSh0eXBlLCBbbWV0aG9kLCBkYXRhXSwgcmlkKTtcblx0XHR9KVxuXHR9XG5cblx0b25Db25uZWN0KGNhbGxiYWNrOkZ1bmN0aW9uKXtcblx0XHRsZXQgcmlkID0gdGhpcy5hZGRDQihcIm9uQ29ubmVjdFwiLCBjYWxsYmFjayk7XG5cdFx0dGhpcy5yZXEoXCJvbkNvbm5lY3RcIiwgW10sIHJpZCk7XG5cdH1cblx0b25EaXNjb25uZWN0KGNhbGxiYWNrOkZ1bmN0aW9uKXtcblx0XHRsZXQgcmlkID0gdGhpcy5hZGRDQihcIm9uRGlzY29ubmVjdFwiLCBjYWxsYmFjayk7XG5cdFx0dGhpcy5yZXEoXCJvbkRpc2Nvbm5lY3RcIiwgW10sIHJpZCk7XG5cdH1cblx0b25Db25uZWN0RmFpbHVyZShjYWxsYmFjazpGdW5jdGlvbil7XG5cdFx0bGV0IHJpZCA9IHRoaXMuYWRkQ0IoXCJvbkNvbm5lY3RGYWlsdXJlXCIsIGNhbGxiYWNrKTtcblx0XHR0aGlzLnJlcShcIm9uQ29ubmVjdEZhaWx1cmVcIiwgW10sIHJpZCk7XG5cdH1cblx0b25FcnJvcihjYWxsYmFjazpGdW5jdGlvbil7XG5cdFx0bGV0IHJpZCA9IHRoaXMuYWRkQ0IoXCJvbkVycm9yXCIsIGNhbGxiYWNrKTtcblx0XHR0aGlzLnJlcShcIm9uRXJyb3JcIiwgW10sIHJpZCk7XG5cdH1cblxuXHRkaXNjb25uZWN0KCl7XG5cdFx0dGhpcy5yZXEoXCJkaXNjb25uZWN0XCIsIFtdKTtcblx0fVxuXHRjb25uZWN0KCl7XG5cdFx0dGhpcy5yZXEoXCJjb25uZWN0XCIsIFtdKTtcblx0fVxuXG5cdHN1YnNjcmliZTxUPihzdWJqZWN0OiBzdHJpbmcsIGRhdGE6IGFueSwgY2FsbGJhY2s6IEZ1bmN0aW9uKTogUnBjLlN1YlByb21pc2U8VD57XG5cdFx0bGV0IGV2ZW50TmFtZSA9IHRoaXMuc3ViamVjdDJFdmVudE5hbWUoc3ViamVjdCk7XG5cdFx0dGhpcy52ZXJib3NlICYmIHRoaXMubG9nKFwic3Vic2NyaWJlOmV2ZW50TmFtZVwiLCBldmVudE5hbWUpXG5cblx0XHRsZXQgc3Vic2NyaWJlcnM6U3Vic2NyaWJlckl0ZW1bXXx1bmRlZmluZWQgPSB0aGlzLnN1YnNjcmliZXJzLmdldChldmVudE5hbWUpO1xuXHRcdGlmKCFzdWJzY3JpYmVycyl7XG5cdFx0XHRzdWJzY3JpYmVycyA9IFtdO1xuXHRcdFx0dGhpcy5zdWJzY3JpYmVycy5zZXQoZXZlbnROYW1lLCBzdWJzY3JpYmVycyk7XG5cdFx0fVxuXHRcdGxldCB1aWQgPSBVSUQoKTtcblx0XHRzdWJzY3JpYmVycy5wdXNoKHt1aWQsIGNhbGxiYWNrfSk7XG5cblx0XHRsZXQgcCA9IHRoaXMuY2FsbChzdWJqZWN0LCBkYXRhLCBcInN1YnNjcmliZVwiLCB1aWQpIGFzIFJwYy5TdWJQcm9taXNlPFQ+O1xuXG5cdFx0cC51aWQgPSB1aWQ7XG5cdFx0cmV0dXJuIHA7XG5cdH1cblxuXHRzdWJqZWN0MkV2ZW50TmFtZShzdWJqZWN0OnN0cmluZyl7XG5cdFx0bGV0IGV2ZW50TmFtZSA9IHN1YmplY3QucmVwbGFjZShcIm5vdGlmeVwiLCBcIlwiKS5yZXBsYWNlKFwiUmVxdWVzdFwiLCBcIk5vdGlmaWNhdGlvblwiKVxuXHRcdHJldHVybiBldmVudE5hbWVbMF0udG9Mb3dlckNhc2UoKStldmVudE5hbWUuc3Vic3RyKDEpO1xuXHR9XG5cblx0dW5TdWJzY3JpYmUoc3ViamVjdDpzdHJpbmcsIHVpZDpzdHJpbmc9Jycpe1xuXHRcdHRoaXMucmVxKFwidW5TdWJzY3JpYmVcIiwgW3N1YmplY3QsIHVpZF0pXG5cdFx0bGV0IGV2ZW50TmFtZSA9IHRoaXMuc3ViamVjdDJFdmVudE5hbWUoc3ViamVjdCk7XG5cdFx0bGV0IHN1YnNjcmliZXJzOlN1YnNjcmliZXJJdGVtW118dW5kZWZpbmVkID0gdGhpcy5zdWJzY3JpYmVycy5nZXQoZXZlbnROYW1lKTtcblx0XHRpZighc3Vic2NyaWJlcnMpXG5cdFx0XHRyZXR1cm5cblx0XHRpZighdWlkKXtcblx0XHRcdHRoaXMuc3Vic2NyaWJlcnMuZGVsZXRlKGV2ZW50TmFtZSk7XG5cdFx0fWVsc2V7XG5cdFx0XHRzdWJzY3JpYmVycyA9IHN1YnNjcmliZXJzLmZpbHRlcihzdWI9PnN1Yi51aWQhPXVpZClcblx0XHRcdHRoaXMuc3Vic2NyaWJlcnMuc2V0KGV2ZW50TmFtZSwgc3Vic2NyaWJlcnMpO1xuXHRcdH1cblx0fVxuXG59XG5cbmV4cG9ydCBjbGFzcyBSUEMgaW1wbGVtZW50cyBJUlBDe1xuXHRjbGllbnQ6Q2xpZW50O1xuXHRjbGVhbnVwKCl7XG5cdFx0dGhpcy5jbGllbnQuY2xlYW51cCgpO1xuXHR9XG5cdGNvbnN0cnVjdG9yKG9wdGlvbnM6YW55PXt9KXtcblx0XHR0aGlzLmNsaWVudCA9IG9wdGlvbnMuY2xpZW50O1xuXHR9XG5cdG9uQ29ubmVjdChjYWxsYmFjazpGdW5jdGlvbil7XG5cdFx0dGhpcy5jbGllbnQub25Db25uZWN0KGNhbGxiYWNrKTtcblx0fVxuXHRvbkNvbm5lY3RGYWlsdXJlKGNhbGxiYWNrOkZ1bmN0aW9uKXtcblx0XHR0aGlzLmNsaWVudC5vbkNvbm5lY3RGYWlsdXJlKGNhbGxiYWNrKTtcblx0fVxuXHRvbkVycm9yKGNhbGxiYWNrOkZ1bmN0aW9uKXtcblx0XHR0aGlzLmNsaWVudC5vbkVycm9yKGNhbGxiYWNrKTtcblx0fVxuXHRvbkRpc2Nvbm5lY3QoY2FsbGJhY2s6RnVuY3Rpb24pe1xuXHRcdHRoaXMuY2xpZW50Lm9uRGlzY29ubmVjdChjYWxsYmFjayk7XG5cdH1cblx0ZGlzY29ubmVjdCgpe1xuXHRcdHRoaXMuY2xpZW50Py5kaXNjb25uZWN0KCk7XG5cdH1cblx0YXN5bmMgY29ubmVjdCgpe1xuXHRcdHJldHVybiB0aGlzLmNsaWVudD8uY29ubmVjdCgpO1xuXHR9XG5cdHVuU3Vic2NyaWJlKG1ldGhvZDpzdHJpbmcsIHVpZDpzdHJpbmc9Jycpe1xuXHRcdHJldHVybiB0aGlzLmNsaWVudC51blN1YnNjcmliZShtZXRob2QsIHVpZCk7XG5cdH1cblx0c3Vic2NyaWJlPFQsIFI+KG1ldGhvZDpzdHJpbmcsIGRhdGE6YW55LCBjYWxsYmFjazpScGMuY2FsbGJhY2s8Uj4pe1xuXHRcdHJldHVybiB0aGlzLmNsaWVudC5zdWJzY3JpYmU8VD4obWV0aG9kLCBkYXRhLCBjYWxsYmFjayk7XG5cdH1cblx0cmVxdWVzdDxUPihtZXRob2Q6c3RyaW5nLCBkYXRhOmFueSl7XG5cdFx0cmV0dXJuIHRoaXMuY2xpZW50LmNhbGwobWV0aG9kLCBkYXRhKSBhcyBQcm9taXNlPFQ+O1xuXHR9XG5cblx0c3Vic2NyaWJlQ2hhaW5DaGFuZ2VkKGNhbGxiYWNrOlJwYy5jYWxsYmFjazxScGMuQ2hhaW5DaGFuZ2VkTm90aWZpY2F0aW9uPil7XG5cdFx0cmV0dXJuIHRoaXMuc3Vic2NyaWJlPFJwYy5Ob3RpZnlDaGFpbkNoYW5nZWRSZXNwb25zZSwgUnBjLkNoYWluQ2hhbmdlZE5vdGlmaWNhdGlvbj4oXCJub3RpZnlDaGFpbkNoYW5nZWRSZXF1ZXN0XCIsIHt9LCBjYWxsYmFjayk7XG5cdH1cblx0c3Vic2NyaWJlQmxvY2tBZGRlZChjYWxsYmFjazpScGMuY2FsbGJhY2s8UnBjLkJsb2NrQWRkZWROb3RpZmljYXRpb24+KXtcblx0XHRyZXR1cm4gdGhpcy5zdWJzY3JpYmU8UnBjLk5vdGlmeUJsb2NrQWRkZWRSZXNwb25zZSwgUnBjLkJsb2NrQWRkZWROb3RpZmljYXRpb24+KFwibm90aWZ5QmxvY2tBZGRlZFJlcXVlc3RcIiwge30sIGNhbGxiYWNrKTtcblx0fVxuXHRzdWJzY3JpYmVWaXJ0dWFsU2VsZWN0ZWRQYXJlbnRCbHVlU2NvcmVDaGFuZ2VkKGNhbGxiYWNrOlJwYy5jYWxsYmFjazxScGMuVmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlQ2hhbmdlZE5vdGlmaWNhdGlvbj4pe1xuXHRcdHJldHVybiB0aGlzLnN1YnNjcmliZTxScGMuTm90aWZ5VmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlQ2hhbmdlZFJlc3BvbnNlLCBScGMuVmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlQ2hhbmdlZE5vdGlmaWNhdGlvbj4oXCJub3RpZnlWaXJ0dWFsU2VsZWN0ZWRQYXJlbnRCbHVlU2NvcmVDaGFuZ2VkUmVxdWVzdFwiLCB7fSwgY2FsbGJhY2spO1xuXHR9XG5cblx0c3Vic2NyaWJlVXR4b3NDaGFuZ2VkKGFkZHJlc3NlczpzdHJpbmdbXSwgY2FsbGJhY2s6UnBjLmNhbGxiYWNrPFJwYy5VdHhvc0NoYW5nZWROb3RpZmljYXRpb24+KXtcblx0XHRyZXR1cm4gdGhpcy5zdWJzY3JpYmU8UnBjLk5vdGlmeVV0eG9zQ2hhbmdlZFJlc3BvbnNlLCBScGMuVXR4b3NDaGFuZ2VkTm90aWZpY2F0aW9uPihcIm5vdGlmeVV0eG9zQ2hhbmdlZFJlcXVlc3RcIiwge2FkZHJlc3Nlc30sIGNhbGxiYWNrKTtcblx0fVxuXG5cdHVuU3Vic2NyaWJlVXR4b3NDaGFuZ2VkKHVpZDpzdHJpbmc9Jycpe1xuXHRcdHRoaXMudW5TdWJzY3JpYmUoXCJub3RpZnlVdHhvc0NoYW5nZWRSZXF1ZXN0XCIsIHVpZCk7XG5cdH1cblxuXHRnZXRCbG9jayhoYXNoOnN0cmluZyl7XG5cdFx0cmV0dXJuIHRoaXMucmVxdWVzdDxScGMuQmxvY2tSZXNwb25zZT4oJ2dldEJsb2NrUmVxdWVzdCcsIHtoYXNoLCBpbmNsdWRlQmxvY2tWZXJib3NlRGF0YTp0cnVlfSk7XG5cdH1cblx0Z2V0VHJhbnNhY3Rpb25zQnlBZGRyZXNzZXMoc3RhcnRpbmdCbG9ja0hhc2g6c3RyaW5nLCBhZGRyZXNzZXM6c3RyaW5nW10pe1xuXHRcdHJldHVybiB0aGlzLnJlcXVlc3Q8UnBjLlRyYW5zYWN0aW9uc0J5QWRkcmVzc2VzUmVzcG9uc2U+KCdnZXRUcmFuc2FjdGlvbnNCeUFkZHJlc3Nlc1JlcXVlc3QnLCB7XG5cdFx0XHRzdGFydGluZ0Jsb2NrSGFzaCwgYWRkcmVzc2VzXG5cdFx0fSk7XG5cdH1cblx0Z2V0VXR4b3NCeUFkZHJlc3NlcyhhZGRyZXNzZXM6c3RyaW5nW10pe1xuXHRcdHJldHVybiB0aGlzLnJlcXVlc3Q8UnBjLlVUWE9zQnlBZGRyZXNzZXNSZXNwb25zZT4oJ2dldFV0eG9zQnlBZGRyZXNzZXNSZXF1ZXN0Jywge2FkZHJlc3Nlc30pO1xuXHR9XG5cdHN1Ym1pdFRyYW5zYWN0aW9uKHR4OiBScGMuU3VibWl0VHJhbnNhY3Rpb25SZXF1ZXN0KXtcblx0XHRyZXR1cm4gdGhpcy5yZXF1ZXN0PFJwYy5TdWJtaXRUcmFuc2FjdGlvblJlc3BvbnNlPignc3VibWl0VHJhbnNhY3Rpb25SZXF1ZXN0JywgdHgpO1xuXHR9XG5cblx0Z2V0VmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlKCl7XG5cdFx0cmV0dXJuIHRoaXMucmVxdWVzdDxScGMuVmlydHVhbFNlbGVjdGVkUGFyZW50Qmx1ZVNjb3JlUmVzcG9uc2U+KCdnZXRWaXJ0dWFsU2VsZWN0ZWRQYXJlbnRCbHVlU2NvcmVSZXF1ZXN0Jywge30pO1xuXHR9XG5cblx0Z2V0QmxvY2tEYWdJbmZvKCl7XG5cdFx0cmV0dXJuIHRoaXMucmVxdWVzdDxScGMuR2V0QmxvY2tEYWdJbmZvUmVzcG9uc2U+KCdnZXRCbG9ja0RhZ0luZm9SZXF1ZXN0Jywge30pO1xuXHR9XG5cdHN1YnNjcmliZVZpcnR1YWxEYWFTY29yZUNoYW5nZWQoY2FsbGJhY2s6UnBjLmNhbGxiYWNrPFJwYy5WaXJ0dWFsRGFhU2NvcmVDaGFuZ2VkTm90aWZpY2F0aW9uPil7XG5cdFx0cmV0dXJuIHRoaXMuc3Vic2NyaWJlPFJwYy5Ob3RpZnlWaXJ0dWFsRGFhU2NvcmVDaGFuZ2VkUmVzcG9uc2UsIFJwYy5WaXJ0dWFsRGFhU2NvcmVDaGFuZ2VkTm90aWZpY2F0aW9uPihcIm5vdGlmeVZpcnR1YWxEYWFTY29yZUNoYW5nZWRSZXF1ZXN0XCIsIHt9LCBjYWxsYmFjayk7XG5cdH1cbn1cbiJdfQ==